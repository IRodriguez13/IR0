name: Update LOC

on:
  push:
    branches: [mainline]

jobs:
  contar-lineas:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - run: sudo apt-get install -y cloc

      # Count lines including Rust (.rs) and C++ (.cpp) files for multi-language kernel
      - run: |
          echo "Counting lines of code (C, C++, Rust, ASM)..."
          cloc --json \
               --include-lang=C,C++,Rust,"Assembly" \
               --by-file-by-lang \
               . > loc.json
          echo "LOC count complete"


      # ðŸ”¹ Paso de ping para despertar la API
      - run: |
          echo "Ping a la API para despertar el server..."
          curl -s https://ir0-loc.onrender.com/ || true
          sleep 14

      # ðŸ”¹ Paso de POST del loc.json
      - run: |
          echo "Enviando loc.json a la API..."
          curl -X POST https://ir0-loc.onrender.com/api/loc \
               -H "Content-Type: application/json" \
               -d @loc.json

      # ðŸ”¹ Obtener contribuidores del repositorio
      - name: Fetch and send contributors
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Obteniendo contribuidores del repositorio..."
          
          # Obtener owner y repo del contexto de GitHub
          OWNER="${{ github.repository_owner }}"
          REPO="${{ github.event.repository.name }}"
          
          # Hacer GET a la API de GitHub para obtener contribuidores
          curl -s -H "Authorization: token $GITHUB_TOKEN" \
               -H "Accept: application/vnd.github.v3+json" \
               "https://api.github.com/repos/IRodriguez13/IR0/contributors" \
               > contributors.json
          
          echo "Contribuidores obtenidos, enviando al endpoint Flask..."
          
          # Enviar JSON de contribuidores al endpoint Flask
          curl -X POST https://ir0-loc.onrender.com/api/contributors \
               -H "Content-Type: application/json" \
               -d @contributors.json
          
          echo "âœ“ Contribuidores enviados exitosamente"
