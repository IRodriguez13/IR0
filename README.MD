# IR0 Kernel

**IR0** is a custom monolithic kernel written from scratch in C and assembly, designed to explore low-level OS development with a clean and modular architecture. It's inspired by Linux but built for learning and experimentation.

The kernel features a sophisticated multi-scheduler system, comprehensive memory management, and a flexible build system that supports multiple architectures and build targets.

---

## ğŸš€ Quick Start

### Prerequisites
```bash
# Install dependencies
sudo apt-get install build-essential nasm grub-pc-bin xorriso qemu-system-x86

# For ARM support (optional)
./scripts/install_arm_deps.sh
```

### Build & Run
```bash
# Quick build (x86-32 desktop)
make

# Build for specific architecture and target
make ARCH=x86-64 BUILD_TARGET=desktop

# Build all combinations
./scripts/build_all.sh -c

# Interactive menu
./scripts/menu_builder.sh

# Run in QEMU
make run
```

---

## ğŸ”§ Features

### ğŸ§  **Advanced Scheduler System**
- **CFS (Completely Fair Scheduler)**: Linux-style fair scheduling with red-black trees
- **Priority Scheduler**: Priority-based scheduling with aging
- **Round-Robin**: Simple fallback scheduler
- **Auto-Detection**: Automatically selects the best scheduler based on available memory

### ğŸ§  **Comprehensive Memory Management**
- **Physical Memory Allocator**: Bitmap-based page management
- **Kernel Heap**: kmalloc/kfree/krealloc implementation
- **Virtual Memory**: On-demand paging system
- **Memory Zones**: Organized memory layout (kernel, heap, user space)

### âš¡ **Interrupt & Timer System**
- **IDT Management**: Complete interrupt descriptor table
- **ISR Handlers**: Custom interrupt service routines
- **Multi-Timer Support**: PIT, HPET, and LAPIC timers
- **Page Fault Handling**: Sophisticated memory fault management

### ğŸ“ **File System**
- **VFS (Virtual File System)**: Simple but functional file system
- **Basic Operations**: Open, read, write, close
- **Extensible Design**: Easy to add new file system types

### ğŸ—ï¸ **Architecture Support**
- **x86-32**: Full 32-bit support with protected mode
- **x86-64**: 64-bit long mode support
- **ARM32/ARM64**: Cross-compilation support (infrastructure ready)

### ğŸ¯ **Build Targets**
- **Desktop**: Full-featured system with GUI support
- **Server**: Optimized for server workloads
- **IoT**: Lightweight system for embedded devices
- **Embedded**: Minimal system without file system

---

## ğŸ“ Project Structure

```
ir0-kernel/
â”œâ”€â”€ arch/                    # Architecture-specific code
â”‚   â”œâ”€â”€ x86-32/            # 32-bit x86 support
â”‚   â”œâ”€â”€ x86-64/            # 64-bit x86 support
â”‚   â””â”€â”€ common/            # Common architecture code
â”œâ”€â”€ kernel/                 # Core kernel subsystems
â”‚   â”œâ”€â”€ scheduler/         # Multi-scheduler system
â”‚   â””â”€â”€ core/              # Kernel initialization
â”œâ”€â”€ memory/                # Memory management
â”‚   â”œâ”€â”€ heap_allocator.c   # Kernel heap (kmalloc)
â”‚   â”œâ”€â”€ physical_allocator.c # Physical page management
â”‚   â””â”€â”€ ondemand-paging.c  # Virtual memory
â”œâ”€â”€ interrupt/             # Interrupt handling
â”œâ”€â”€ drivers/               # Device drivers
â”œâ”€â”€ fs/                    # File system
â”œâ”€â”€ scripts/               # Build and utility scripts
â””â”€â”€ setup/                 # Kernel configuration
```

---

## ğŸ§  Kernel Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    USER SPACE (Future)                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                   KERNEL SPACE (IR0)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   SCHEDULER SYSTEM  â”‚  MEMORY SYSTEM  â”‚  INTERRUPT SYSTEM   â”‚
â”‚                     â”‚                 â”‚                     â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ CFS Scheduler   â”‚ â”‚ â”‚ Physical    â”‚ â”‚ â”‚ IDT Manager     â”‚ â”‚
â”‚ â”‚ Priority Sched  â”‚ â”‚ â”‚ Allocator   â”‚ â”‚ â”‚ ISR Handlers    â”‚ â”‚
â”‚ â”‚ Round Robin     â”‚ â”‚ â”‚             â”‚ â”‚ â”‚ Page Fault      â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                     â”‚ â”‚ Heap        â”‚ â”‚                     â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ Allocator   â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ Task Manager    â”‚ â”‚ â”‚ (kmalloc)   â”‚ â”‚ â”‚ Timer System    â”‚ â”‚
â”‚ â”‚ Context Switch  â”‚ â”‚ â”‚             â”‚ â”‚ â”‚ HPET/LAPIC/PIT  â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                     â”‚ â”‚ Virtual     â”‚ â”‚                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚ Allocator   â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                     â”‚ â”‚ (vmalloc)   â”‚ â”‚                     â”‚
â”‚    ARCH LAYER       â”‚ â”‚             â”‚ â”‚    DEVICE DRIVERS   â”‚
â”‚                     â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚                     â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ On-Demand   â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ x86-32 Support  â”‚ â”‚ â”‚ Paging      â”‚ â”‚ â”‚ VGA Display     â”‚ â”‚
â”‚ â”‚ x86-64 Support  â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ Storage (TODO)  â”‚ â”‚
â”‚ â”‚ ARM Support     â”‚ â”‚                 â”‚ â”‚ Network (TODO)  â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                    HARDWARE ABSTRACTION                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”§ Build System

### Multi-Architecture Support
The kernel supports multiple architectures with conditional compilation:

```bash
# x86 architectures
make ARCH=x86-32 BUILD_TARGET=desktop
make ARCH=x86-64 BUILD_TARGET=server

# ARM architectures (requires cross-compiler)
make ARCH=arm32 BUILD_TARGET=iot
make ARCH=arm64 BUILD_TARGET=embedded
```

### Build Targets
Different build targets enable/disable features:

| Target | Features | Use Case |
|--------|----------|----------|
| **desktop** | GUI, audio, USB, networking, filesystem | Desktop computers |
| **server** | Networking, filesystem, high performance | Server systems |
| **iot** | Minimal features, power management | IoT devices |
| **embedded** | Core only, no filesystem | Embedded systems |

### Build Scripts
```bash
# Build all combinations (16 total)
./scripts/build_all.sh -c

# Build all architectures
./scripts/build_all.sh -a

# Build all targets
./scripts/build_all.sh -t

# Interactive build menu
./scripts/menu_builder.sh

# Create custom ISO
./scripts/create_iso.sh -a x86-64 -t desktop -o my-kernel.iso
```

---

## ğŸ§  Scheduler System

The kernel features a sophisticated multi-scheduler system inspired by Linux:

### CFS (Completely Fair Scheduler)
- **Red-Black Tree**: Efficient task selection
- **Virtual Runtime**: Fair time distribution
- **Nice Values**: Process priority support
- **Load Balancing**: Automatic load distribution

### Priority Scheduler
- **Priority Lists**: 140 priority levels
- **Aging**: Prevents starvation
- **Bitmap**: Fast priority selection

### Round-Robin Scheduler
- **Simple**: Minimal memory usage
- **Fallback**: Used when memory is limited
- **Fair**: Equal time slices

### Auto-Detection
The system automatically selects the best scheduler:
- **CFS**: When >1000 free pages available
- **Priority**: When >100 free pages available  
- **Round-Robin**: When memory is limited

---

## ğŸ§  Memory Management

### Physical Memory Allocator
- **Bitmap Management**: Tracks free/used pages
- **Page Allocation**: 4KB page granularity
- **Memory Statistics**: Tracks usage patterns

### Kernel Heap Allocator
- **kmalloc()**: Allocate kernel memory
- **kfree()**: Free kernel memory
- **krealloc()**: Resize memory blocks
- **Fragmentation Management**: Coalesces free blocks

### Virtual Memory System
- **On-Demand Paging**: Load pages when needed
- **Page Fault Handling**: Sophisticated fault management
- **Memory Mapping**: Virtual to physical translation

### Memory Layout
```
0x00000000 - 0x04000000: Kernel code/data (64MB)
0x04000000 - 0x06000000: Kernel heap (32MB)
0x06000000 - 0x06400000: Kernel stacks (4MB)
0x10000000 - 0x20000000: vmalloc area (256MB)
0x40000000 - 0x80000000: User space (1GB)
```

---

## ğŸš€ Development Status

| Subsystem | Status | Notes |
|-----------|--------|-------|
| ğŸ§¼ **Bootloader** | âœ… Complete | Custom bootloader, multi-arch support |
| ğŸ§  **Scheduler** | âœ… Advanced | CFS, Priority, Round-Robin with auto-detection |
| ğŸ“¦ **Memory Management** | âœ… Complete | Physical, heap, virtual memory systems |
| âš¡ **Interrupts** | âœ… Complete | IDT, ISRs, page fault handling |
| â² **Timers** | âœ… Complete | PIT, HPET, LAPIC support |
| ğŸ“ **File System** | ğŸš§ Basic | VFS with basic operations |
| ğŸ—ï¸ **Build System** | âœ… Complete | Multi-arch, multi-target support |
| ğŸ”€ **User Space** | ğŸš§ Planned | Process management, syscalls |
| ğŸ–¥ **GUI** | ğŸš§ Planned | Desktop target feature |

---

## ğŸ› ï¸ Development

### Adding New Features
1. **Architecture Support**: Add to `arch/` directory
2. **Device Drivers**: Add to `drivers/` directory  
3. **Build Targets**: Update `Makefile` and `setup/kernel_config.h`
4. **Schedulers**: Implement `scheduler_ops_t` interface

### Code Style
- **C99 Standard**: Use modern C features
- **Documentation**: Extensive comments in Spanish/English
- **Error Handling**: Comprehensive error checking
- **Memory Safety**: Proper allocation/deallocation

### Testing
```bash
# Build and test all combinations
./scripts/build_all.sh -c

# Test specific architecture
make ARCH=x86-64 BUILD_TARGET=desktop run

# Debug mode
make ARCH=x86-32 BUILD_TARGET=desktop debug
```

---

## ğŸ“š Documentation

- **[BUILD_SYSTEM.md](BUILD_SYSTEM.md)**: Complete build system documentation
- **[memory/README](memory/README)**: Memory management details
- **[kernel/scheduler/](kernel/scheduler/)**: Scheduler implementation details

---

## ğŸ¤ Contributing

This project is designed for learning and experimentation. Contributions are welcome:

1. **Fork** the repository
2. **Create** a feature branch
3. **Implement** your changes
4. **Test** with multiple architectures/targets
5. **Submit** a pull request

### Development Guidelines
- Maintain compatibility with all architectures
- Add comprehensive documentation
- Test with all build targets
- Follow existing code style

---

## ğŸ“„ License

This project is open source. See [LICENSE](LICENSE) for details.

---

## ğŸ™ Acknowledgments

- **Linux Kernel**: Inspiration for scheduler and memory management
- **OSDev Wiki**: Valuable resources for OS development
- **QEMU**: For emulation and testing
- **GCC/GNU**: For cross-compilation support

---

*IR0 Kernel - Where learning meets real-world OS development* ğŸš€

