# IR0 KERNEL: NETWORK STACK DEVELOPMENT GUIDE

This document establishes the architecture for networking protocols (ARP, IP, ICMP, etc.) and how they interact with the networking abstraction layer in IR0.

## 1. LAYERED ARCHITECTURE

IR0 uses a standard layered model. Each protocol is implemented in the `/net` directory:

- **Layer 2 (Data Link)**: Ethernet (managed by the abstraction layer).
- **Layer 2.5**: ARP (Address Resolution Protocol).
- **Layer 3 (Network)**: IPv4, ICMP.
- **Layer 4 (Transport)**: UDP, TCP (future).

## 2. NETWORKING ABSTRACTION LAYER

To decouple hardware from protocols, use the `net_device` API defined in `<ir0/net.h>`.

### Hardware Drivers
Drivers must register a `struct net_device` instance:
```c
struct net_device {
    const char *name;           /* Device name (e.g., "eth0") */
    mac_addr_t mac;             /* Hardware MAC address */
    void *priv;                 /* Driver private state */
    int (*send)(struct net_device *dev, void *data, size_t len);
};

int net_register_device(struct net_device *dev);
```

### Protocol Implementation
Protocols should NOT call driver functions directly. Use the core API:

#### Sending Data
```c
int net_send(struct net_device *dev, 
             uint16_t ethertype, 
             const uint8_t *dest_mac, 
             const void *payload, 
             size_t len);
```
- **ethertype**: `ETHERTYPE_IP` (0x0800), `ETHERTYPE_ARP` (0x0806), etc.
- This function automatically handles Ethernet framing.

#### Receiving Data
The core layer dispatches packets via `net_receive(dev, data, len)`.
Update the `switch` statement in `net/net_core.c` to hook your protocol:
```c
switch (type) {
    case ETHERTYPE_ARP:
        arp_receive(dev, data, len);
        break;
    case ETHERTYPE_IP:
        ip_receive(dev, data, len);
        break;
}
```

## 3. SUPPORTED HARDWARE: RTL8139

The primary supported NIC is the **RTL8139**.
- **Driver**: `drivers/net/rtl8139.c`
- **Features**: PCI discovery, DMA transmission, Interrupt-driven reception (ROK).
- **MTU**: 1500 bytes.

## 4. BYTE ORDER (Endianness)

Network protocols use **Big Endian**. Use the macros in `<ir0/net.h>`:
- `htons()`, `ntohs()`: 16-bit.
- `htonl()`, `ntohl()`: 32-bit.

## 5. CORE UTILITIES

- **Memory**: Use `kmalloc` / `kfree` from `<ir0/memory/kmem.h>`.
- **Logging**: Use `serial_print` for network debugging.
- **Headers**: See `<ir0/net.h>` for standard Ethernet structures.

---
*Note: This architecture ensures that ARP doesn't see IRQs, IP doesn't see DMA, and the driver doesn't see IPs.*
